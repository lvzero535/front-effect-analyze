# 分析ts文件

分析ts文件的过程中，所有声明结构为：IDeclareVar。文件分析结果结构为FileAnalyzeResult。

```typescript
export type VarType = 'function' | 'class' | 'const' | 'let' | 'var' | 'interface' | 'type' | 'enum';

/**
 * 文件或函数中声明变量的分析结构
 * isExported和isImported会同时为true，当变量是从另一个模块导入并重新导出时
 */
export interface IDeclareVar {
  /**
   * 声明的变量名
   */
  name: string;

  /**
   * 变量的类型, 如 function, class, const 等
   */
  type: VarType;

  /**
   * 是否导出
   */
  isExported: boolean;

  /**
   * 是否是导入的变量
   */
  isImported: boolean;

  /**
   * 是否为TS类型声明，如 interface, type 等
   */
  isTsType: boolean;

  /**
   * 如果isImported为true，则为导入路径
   * 如：import { TabsModule } from '@/store/modules/tabs';
   * 则 moduleSpecifier 为 'E:/DevPrograms/CodeRepository/dev-products/nest-vue-app/nest-vue-web/src/store/modules/tabs'
   * 如：import { TabsModule } from 'vuex-module-decorators';
   * 则 moduleSpecifier 为 'vuex-module-decorators'
   */
  moduleSpecifier?: string;

  /**
   * 这个变量所依赖的其他变量，如函数调用中使用的变量，对象属性引用了其他变量等
   */
  dependencies: IDeclareVar[];
}

/**
 * 文件分析结果
 */
export interface FileAnalyzeResult {
  /**
   * 当前文件路径
   */
  path: string;

  /**
   * 文件类型
   */
  fileType: 'ts' | 'js' | 'vue';

  /**
   * 文件依赖的其他文件路径
   */
  moduleSpecifiers: Array<string>;

  /**
   * 文件中声明的变量
   */
  declareVars: IDeclareVar[];
}

```

## 分析所有import语句

### 分析moduleSpecifier

编写一个函数resolveModuleSpecifier，用于分析import语句中的moduleSpecifier。根据tsconfig中的baseUrl和paths配置，将moduleSpecifier转换为绝对路径。

- 如果是第三方安装的模块，直接返回moduleSpecifier。
- 如果是相对路径，根据baseUrl和paths配置，将其转换为绝对路径。

```typescript
function resolveModuleSpecifier(moduleSpecifier: string, tsconfig: object, installDeps: string[]): string {
}
```

### 分析importClause

把每一行的importClause中的每一个变量名提取出来，存在一个定好的结构中，结构为上面定义的IDeclareVar， 并将其添加到FileAnalyzeResult的IDeclareVars中，这里的结构中的isImported设置为true。

### 分析exportClause

把每一行的exportClause中的每一个变量名提取出来，存在一个定好的结构中，结构为上面定义的IDeclareVar， 并将其添加到FileAnalyzeResult的IDeclareVars中，这里的结构中的isExported设置为true。

## 分析Statements

编写一个函数analyzeStatements，用于分析ts文件中的Statements（不包含import语句），提取所有的变量声明，存在一个定好的结构中，结构为上面定义的IDeclareVar。添加到FileAnalyzeResult的IDeclareVars中。

1. 判断声明如果是函数声明，将其类型设置为function，并遍历函数体，提取所有的变量声明，将其添加结构IDeclareVar的IDeclareVars中的,如果存在exportClause，将其添加到IDeclareVar的dependencies中的。
2. 判断声明中存在函数体（如函数调用中参数中存在函数体），并遍历函数体，提取所有的变量声明，将其添加到当前结构IDeclareVar的IDeclareVars中的。
3. 如果函数体中引用了importClause中的变量，将其添加到IDeclareVar的dependencies中。
4. 如果是函数体内存在函数体， 递归分析函数体，这里只需要判断是否引用了importClause中的变量， 如果引用了，将其添加到第一层函数体IDeclareVar的dependencies中，无需分析函数体中的变量声明。
